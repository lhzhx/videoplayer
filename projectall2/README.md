# å¤šåª’ä½“æ’­æ”¾å™¨é¡¹ç›®

ä¸€ä¸ªåŸºäºC++å¼€å‘çš„é«˜æ€§èƒ½éŸ³è§†é¢‘æ’­æ”¾å™¨ç³»ç»Ÿï¼Œæ”¯æŒæœ¬åœ°æ–‡ä»¶æ’­æ”¾å’Œç½‘ç»œæµåª’ä½“ä¼ è¾“ã€‚

## ğŸ¯ é¡¹ç›®ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- **å¤šæºæ’­æ”¾æ”¯æŒ**ï¼šæ”¯æŒæœ¬åœ°è§†é¢‘æ–‡ä»¶æ’­æ”¾å’Œç½‘ç»œæµåª’ä½“æ’­æ”¾
- **éŸ³è§†é¢‘åŒæ­¥**ï¼šå®ç°ç²¾ç¡®çš„éŸ³è§†é¢‘åŒæ­¥æ’­æ”¾
- **äº¤äº’å¼æ§åˆ¶**ï¼šæ”¯æŒæ’­æ”¾/æš‚åœã€å¿«è¿›/å¿«é€€ç­‰åŸºæœ¬æ’­æ”¾æ§åˆ¶
- **é«˜æ€§èƒ½æ¸²æŸ“**ï¼šåŸºäºOpenGLçš„ç¡¬ä»¶åŠ é€Ÿè§†é¢‘æ¸²æŸ“
- **ä½å»¶è¿ŸéŸ³é¢‘**ï¼šä½¿ç”¨ALSAå®ç°ä½å»¶è¿ŸéŸ³é¢‘è¾“å‡º

### æŠ€æœ¯äº®ç‚¹
- **å¤šçº¿ç¨‹æ¶æ„**ï¼šé‡‡ç”¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼ŒéŸ³è§†é¢‘è§£ç å’Œæ¸²æŸ“åˆ†ç¦»
- **ç½‘ç»œæµåª’ä½“**ï¼šè‡ªå®šä¹‰TCPåè®®å®ç°å®æ—¶æµåª’ä½“ä¼ è¾“
- **é«˜æ•ˆI/O**ï¼šæœåŠ¡ç«¯ä½¿ç”¨epollå®ç°é«˜å¹¶å‘è¿æ¥å¤„ç†
- **å†…å­˜ç®¡ç†**ï¼šæ™ºèƒ½æŒ‡é’ˆå’ŒRAIIæ¨¡å¼ç¡®ä¿èµ„æºå®‰å…¨

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### å®¢æˆ·ç«¯ç»„ä»¶

#### æ ¸å¿ƒæ¨¡å—
- **MediaDecoder**ï¼šåª’ä½“è§£ç å™¨ï¼Œæ”¯æŒæœ¬åœ°æ–‡ä»¶å’Œç½‘ç»œæµè§£ç 
- **VideoRenderer**ï¼šOpenGLè§†é¢‘æ¸²æŸ“å™¨ï¼Œå¤„ç†YUV420Pæ ¼å¼è½¬æ¢å’Œæ˜¾ç¤º
- **AudioOutput**ï¼šALSAéŸ³é¢‘è¾“å‡ºç®¡ç†
- **NetworkClient**ï¼šTCPç½‘ç»œå®¢æˆ·ç«¯ï¼Œå¤„ç†æµåª’ä½“æ•°æ®æ¥æ”¶

#### æ•°æ®ç®¡ç†
- **FrameQueue**ï¼šçº¿ç¨‹å®‰å…¨çš„è§†é¢‘å¸§é˜Ÿåˆ—
- **AudioFrameQueue**ï¼šéŸ³é¢‘å¸§ç¼“å†²é˜Ÿåˆ—

### æœåŠ¡ç«¯ç»„ä»¶
- **TCP Epoll Server**ï¼šé«˜æ€§èƒ½æµåª’ä½“æœåŠ¡å™¨
  - åŸºäºepollçš„äº‹ä»¶é©±åŠ¨æ¶æ„
  - æ”¯æŒå¤šå®¢æˆ·ç«¯å¹¶å‘è¿æ¥
  - å®æ—¶è§†é¢‘æµåˆ†å‘
  - è‡ªå®šä¹‰æ•°æ®åŒ…åè®®

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### å¤šåª’ä½“å¤„ç†
- **FFmpeg**ï¼šéŸ³è§†é¢‘ç¼–è§£ç ã€æ ¼å¼è½¬æ¢
- **libavformat/libavcodec**ï¼šåª’ä½“å®¹å™¨å’Œç¼–è§£ç å™¨
- **libswscale/libswresample**ï¼šå›¾åƒå’ŒéŸ³é¢‘é‡é‡‡æ ·

### å›¾å½¢æ¸²æŸ“
- **OpenGL**ï¼šç¡¬ä»¶åŠ é€Ÿå›¾å½¢æ¸²æŸ“
- **GLFW**ï¼šè·¨å¹³å°çª—å£ç®¡ç†
- **GLEW**ï¼šOpenGLæ‰©å±•åŠ è½½

### éŸ³é¢‘å¤„ç†
- **ALSA**ï¼šLinuxéŸ³é¢‘å­ç³»ç»Ÿæ¥å£

### ç½‘ç»œé€šä¿¡
- **TCP Socket**ï¼šå¯é çš„ç½‘ç»œæ•°æ®ä¼ è¾“
- **epoll**ï¼šé«˜æ•ˆçš„I/Oäº‹ä»¶é€šçŸ¥æœºåˆ¶

### æ„å»ºç³»ç»Ÿ
- **CMake**ï¼šè·¨å¹³å°æ„å»ºé…ç½®
- **pkg-config**ï¼šä¾èµ–åº“ç®¡ç†

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚

### ä¾èµ–åº“
- FFmpeg (libavformat, libavcodec, libswscale, libswresample, libavutil)
- OpenGL
- GLFW3
- GLEW
- ALSA
- libjpeg
- libpng
- pthread

### ç¼–è¯‘ç¯å¢ƒ
- CMake 3.10+
- C++17 æ”¯æŒçš„ç¼–è¯‘å™¨
- pkg-config

## ğŸš€ ç¼–è¯‘å’Œå®‰è£…

### 1. å®‰è£…ä¾èµ–

#### Ubuntu/Debian
```bash
sudo apt-get update
sudo apt-get install cmake build-essential pkg-config
sudo apt-get install libavformat-dev libavcodec-dev libswscale-dev libswresample-dev libavutil-dev
sudo apt-get install libgl1-mesa-dev libglfw3-dev libglew-dev
sudo apt-get install libasound2-dev libjpeg-dev libpng-dev
```

#### CentOS/RHEL
```bash
sudo yum install cmake gcc-c++ pkgconfig
sudo yum install ffmpeg-devel
sudo yum install mesa-libGL-devel glfw-devel glew-devel
sudo yum install alsa-lib-devel libjpeg-turbo-devel libpng-devel
```

### 2. ç¼–è¯‘é¡¹ç›®

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd projectall2/media_player

# åˆ›å»ºæ„å»ºç›®å½•
mkdir -p build
cd build

# é…ç½®å’Œç¼–è¯‘
cmake ..
make

# ç¼–è¯‘æœåŠ¡å™¨
cd ../../tcpepollserver
g++ -o test_server_epoll test_server_epoll.cpp -lavformat -lavcodec -lavutil
```

## ğŸ® ä½¿ç”¨æ–¹æ³•

### æœ¬åœ°æ–‡ä»¶æ’­æ”¾
```bash
./media_player video_file.mp4
```

### ç½‘ç»œæµæ’­æ”¾

#### 1. å¯åŠ¨æµåª’ä½“æœåŠ¡å™¨
```bash
./test_server_epoll <port> <video_file>
# ä¾‹å¦‚ï¼š./test_server_epoll 8080 sample.mp4
```

#### 2. è¿æ¥æ’­æ”¾
```bash
./media_player --network <server_ip> <port>
# ä¾‹å¦‚ï¼š./media_player --network 127.0.0.1 8080
```

### æ’­æ”¾æ§åˆ¶
- **ç©ºæ ¼é”®**ï¼šæ’­æ”¾/æš‚åœ
- **å·¦ç®­å¤´**ï¼šå¿«é€€5ç§’ï¼ˆä»…æœ¬åœ°æ–‡ä»¶ï¼‰
- **å³ç®­å¤´**ï¼šå¿«è¿›5ç§’ï¼ˆä»…æœ¬åœ°æ–‡ä»¶ï¼‰
- **Qé”®**ï¼šé€€å‡ºæ’­æ”¾å™¨

## ğŸ“ é¡¹ç›®ç»“æ„

```
projectall2/
â”œâ”€â”€ README.md                 # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ VID_20230311_211931.mp4   # ç¤ºä¾‹è§†é¢‘æ–‡ä»¶
â”œâ”€â”€ media_player/             # å®¢æˆ·ç«¯æ’­æ”¾å™¨
â”‚   â”œâ”€â”€ CMakeLists.txt        # æ„å»ºé…ç½®
â”‚   â”œâ”€â”€ build/                # æ„å»ºè¾“å‡ºç›®å½•
â”‚   â”‚   â””â”€â”€ media_player      # å¯æ‰§è¡Œæ–‡ä»¶
â”‚   â”œâ”€â”€ include/              # å¤´æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ AudioFrameQueue.h
â”‚   â”‚   â”œâ”€â”€ AudioOutput.h
â”‚   â”‚   â”œâ”€â”€ FrameQueue.h
â”‚   â”‚   â”œâ”€â”€ MediaDecoder.h
â”‚   â”‚   â”œâ”€â”€ VideoRenderer.h
â”‚   â”‚   â””â”€â”€ network_client.h
â”‚   â””â”€â”€ src/                  # æºä»£ç 
â”‚       â”œâ”€â”€ AudioFrameQueue.cpp
â”‚       â”œâ”€â”€ AudioOutput.cpp
â”‚       â”œâ”€â”€ FrameQueue.cpp
â”‚       â”œâ”€â”€ MediaDecoder.cpp
â”‚       â”œâ”€â”€ VideoRenderer.cpp
â”‚       â”œâ”€â”€ main.cpp
â”‚       â””â”€â”€ network_client.cpp
â””â”€â”€ tcpepollserver/           # æµåª’ä½“æœåŠ¡å™¨
    â”œâ”€â”€ test_server_epoll.cpp # æœåŠ¡å™¨æºç 
    â”œâ”€â”€ test_server_epoll     # æœåŠ¡å™¨å¯æ‰§è¡Œæ–‡ä»¶
    â””â”€â”€ video_server          # å¤‡ç”¨æœåŠ¡å™¨
```

## ğŸ”§ é…ç½®è¯´æ˜

### ç½‘ç»œåè®®
é¡¹ç›®ä½¿ç”¨è‡ªå®šä¹‰çš„TCPæ•°æ®åŒ…åè®®ï¼š

```cpp
struct PacketHeader {
    uint32_t magic;      // é­”æ•°æ ¡éªŒ (0x12345678)
    uint32_t dataType;   // æ•°æ®ç±»å‹ (0: è§†é¢‘, 1: éŸ³é¢‘, 2: å…ƒæ•°æ®)
    uint32_t dataSize;   // è´Ÿè½½æ•°æ®å¤§å°
    int64_t  pts;        // å¸§æ—¶é—´æˆ³
};
```

### éŸ³è§†é¢‘å‚æ•°
- **è§†é¢‘æ ¼å¼**ï¼šYUV420P
- **éŸ³é¢‘æ ¼å¼**ï¼šæµ®ç‚¹PCM
- **åŒæ­¥æœºåˆ¶**ï¼šåŸºäºPTSæ—¶é—´æˆ³

## ğŸ¯ åº”ç”¨åœºæ™¯

- **æœ¬åœ°åª’ä½“æ’­æ”¾**ï¼šæ”¯æŒå¸¸è§è§†é¢‘æ ¼å¼çš„æœ¬åœ°æ’­æ”¾
- **æµåª’ä½“æœåŠ¡**ï¼šæ„å»ºç®€å•çš„è§†é¢‘ç‚¹æ’­ç³»ç»Ÿ
- **å®æ—¶ä¼ è¾“**ï¼šä½å»¶è¿Ÿçš„éŸ³è§†é¢‘æµä¼ è¾“
- **æ•™è‚²æ¼”ç¤º**ï¼šå¤šåª’ä½“ç¼–ç¨‹å­¦ä¹ å’Œæ¼”ç¤º
- **åŸå‹å¼€å‘**ï¼šå¿«é€ŸéªŒè¯éŸ³è§†é¢‘å¤„ç†ç®—æ³•

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç¼–è¯‘é”™è¯¯ï¼šæ‰¾ä¸åˆ°FFmpegåº“**
   ```bash
   # ç¡®ä¿å®‰è£…äº†å¼€å‘åŒ…
   sudo apt-get install libavformat-dev libavcodec-dev
   ```

2. **è¿è¡Œæ—¶é”™è¯¯ï¼šæ— æ³•æ‰“å¼€éŸ³é¢‘è®¾å¤‡**
   ```bash
   # æ£€æŸ¥ALSAé…ç½®
   aplay -l
   ```

3. **ç½‘ç»œè¿æ¥å¤±è´¥**
   - æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
   - ç¡®è®¤æœåŠ¡å™¨ç«¯å£æœªè¢«å ç”¨
   - éªŒè¯ç½‘ç»œè¿é€šæ€§

4. **è§†é¢‘æ— æ³•æ˜¾ç¤º**
   - ç¡®è®¤OpenGLé©±åŠ¨æ­£å¸¸
   - æ£€æŸ¥è§†é¢‘æ ¼å¼æ”¯æŒ

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ã€‚ä½¿ç”¨çš„ç¬¬ä¸‰æ–¹åº“è¯·éµå¾ªå„è‡ªçš„è®¸å¯è¯æ¡æ¬¾ã€‚

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›é¡¹ç›®ã€‚

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡GitHub Issuesè”ç³»ã€‚

---

**æ³¨æ„**ï¼šæœ¬é¡¹ç›®ä¸»è¦åœ¨Linuxç¯å¢ƒä¸‹å¼€å‘å’Œæµ‹è¯•ï¼ŒWindowsæ”¯æŒå¯èƒ½éœ€è¦é¢å¤–é…ç½®ã€‚